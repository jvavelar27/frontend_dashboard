<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CRM WhatsApp</title>
<style>
:root {
  --sidebar-w: 260px;
  --sidebar-w-collapsed: 72px;

  /* Enhanced Dark Theme Colors */
  --bg: linear-gradient(135deg, #0f1419 0%, #1a202c 100%);
  --bg-soft: rgba(255,255,255,0.04);
  --card: rgba(255,255,255,0.08);
  --card-hover: rgba(255,255,255,0.12);
  --card-border: rgba(255,255,255,0.1);
  --surface: rgba(255,255,255,0.06);
  --text: #f7fafc;
  --text-soft: #e2e8f0;
  --muted: #a0aec0;
  --muted-soft: #718096;
  --accent: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --accent-solid: #667eea;
  --accent-2: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  --accent-2-solid: #48bb78;
  --danger: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  --warning: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
  --info: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
  
  /* Enhanced Shadow System */
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.12);
  --shadow: 0 8px 32px rgba(0,0,0,0.18);
  --shadow-lg: 0 16px 48px rgba(0,0,0,0.25);
  --shadow-xl: 0 24px 64px rgba(0,0,0,0.35);
  --shadow-glow: 0 0 32px rgba(102, 126, 234, 0.15);
  
  --blur: saturate(180%) blur(12px);
  --ring: 0 0 0 3px rgba(102, 126, 234, 0.4);

  /* Enhanced Gradients */
  --glow1: radial-gradient(800px 400px at 10% 20%, rgba(102, 126, 234, 0.15), transparent 50%);
  --glow2: radial-gradient(900px 500px at 90% 80%, rgba(72, 187, 120, 0.12), transparent 50%);
  --glow3: radial-gradient(600px 300px at 50% 0%, rgba(245, 101, 101, 0.08), transparent 40%);
}

html.light {
  /* Enhanced Light Theme */
  --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  --bg-soft: rgba(0,0,0,0.02);
  --card: rgba(255,255,255,0.95);
  --card-hover: rgba(255,255,255,1);
  --card-border: rgba(0,0,0,0.08);
  --surface: rgba(255,255,255,0.8);
  --text: #1a202c;
  --text-soft: #2d3748;
  --muted: #4a5568;
  --muted-soft: #718096;
  --accent: linear-gradient(135deg, #5a67d8 0%, #553c9a 100%);
  --accent-solid: #5a67d8;
  --accent-2: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
  --accent-2-solid: #38a169;
  --danger: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
  --warning: linear-gradient(135deg, #dd6b20 0%, #c05621 100%);
  --info: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
  
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
  --shadow: 0 8px 32px rgba(0,0,0,0.10);
  --shadow-lg: 0 16px 48px rgba(0,0,0,0.15);
  --shadow-xl: 0 24px 64px rgba(0,0,0,0.20);
  --shadow-glow: 0 0 32px rgba(90, 103, 216, 0.12);
  
  --ring: 0 0 0 3px rgba(90, 103, 216, 0.35);

  --glow1: radial-gradient(800px 400px at 10% 20%, rgba(90, 103, 216, 0.12), transparent 50%);
  --glow2: radial-gradient(900px 500px at 90% 80%, rgba(56, 161, 105, 0.10), transparent 50%);
  --glow3: radial-gradient(600px 300px at 50% 0%, rgba(229, 62, 62, 0.06), transparent 40%);
}

/* Enhanced Base Styles */
* { 
  box-sizing: border-box; 
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

html, body { height: 100%; }

body {
  margin: 0;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: var(--text);
  background: var(--bg);
  overflow-x: hidden;
}

/* Enhanced Typography */
h1, h2, h3, h4, h5, h6 {
  line-height: 1.25;
  font-weight: 600;
  margin: 0;
  color: var(--text);
}

h1 { font-size: 2rem; font-weight: 700; }
h2 { font-size: 1.5rem; font-weight: 600; }
h3 { font-size: 1.25rem; font-weight: 600; }
h4 { font-size: 1.125rem; font-weight: 600; }

a { 
  color: inherit; 
  text-decoration: none; 
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

button { 
  font: inherit; 
  color: inherit; 
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

img, svg { 
  display: block; 
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Enhanced Ambient Effects */
.ambient {
  position: fixed;
  pointer-events: none;
  inset: -20% -15% -20% -15%;
  background:
    var(--glow1),
    var(--glow2),
    var(--glow3);
  filter: blur(80px);
  opacity: 0.6;
  z-index: 0;
  animation: ambientFloat 25s ease-in-out infinite;
}

@keyframes ambientFloat {
  0%, 100% { transform: translate3d(0, 0, 0) scale(1) rotate(0deg); }
  25% { transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(1deg); }
  50% { transform: translate3d(2%, 1%, 0) scale(0.98) rotate(-1deg); }
  75% { transform: translate3d(-1%, 2%, 0) scale(1.01) rotate(0.5deg); }
}

/* Enhanced Animations */
@keyframes fadeUp { 
  from { 
    opacity: 0; 
    transform: translateY(20px); 
  } 
  to { 
    opacity: 1; 
    transform: translateY(0); 
  } 
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes softPulse { 
  0%, 100% { 
    box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4), var(--shadow); 
  } 
  50% { 
    box-shadow: 0 0 32px 8px rgba(102, 126, 234, 0.15), var(--shadow-lg); 
  }
}

@keyframes glow { 
  0%, 100% { 
    filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.3)); 
  } 
  50% { 
    filter: drop-shadow(0 0 16px rgba(102, 126, 234, 0.5)); 
  } 
}

@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

/* Enhanced Layout */
.app {
  position: relative;
  display: grid;
  grid-template-columns: var(--sidebar-w) 1fr;
  grid-template-rows: 1fr;
  grid-template-areas: "sidebar main";
  min-height: 100vh;
  transition: grid-template-columns 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1;
}

/* Enhanced Sidebar */
aside {
  grid-area: sidebar;
  position: sticky; 
  top: 0; 
  align-self: start;
  height: 100vh; 
  overflow: hidden auto;
  background: var(--surface);
  backdrop-filter: var(--blur);
  border-right: 1px solid var(--card-border);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 20;
  box-shadow: var(--shadow);
}

aside.collapsed { width: var(--sidebar-w-collapsed); }
aside:not(.collapsed) { width: var(--sidebar-w); }

/* Enhanced Navigation */
.nav { padding: 16px 12px; }

.nav .brand {
  display: flex; 
  align-items: center; 
  gap: 12px;
  margin: 12px 8px 20px 8px; 
  font-weight: 700; 
  font-size: 16px; 
  letter-spacing: -0.02em;
  color: var(--text);
}

.nav .brand svg {
  width: 24px;
  height: 24px;
  filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3));
}

.nav h4 {
  margin: 20px 12px 8px 12px;
  font-size: 11px; 
  color: var(--muted); 
  font-weight: 700; 
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.nav a {
  display: grid; 
  grid-template-columns: 28px 1fr; 
  align-items: center; 
  gap: 12px;
  padding: 14px 16px; 
  margin: 4px 0;
  border-radius: 16px;
  color: var(--text-soft); 
  border: 1px solid transparent;
  font-weight: 500;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.nav a::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.nav a:hover::before {
  transform: translateX(100%);
}

.nav a .label { 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  font-size: 14px;
}

aside.collapsed .nav a .label { 
  opacity: 0;
  transform: translateX(-10px);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

aside:not(.collapsed) .nav a .label { 
  opacity: 1;
  transform: translateX(0);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) 0.1s;
}

.nav a.active { 
  background: var(--accent-solid);
  border-color: var(--accent-solid);
  color: white;
  box-shadow: var(--shadow-glow);
  transform: translateY(-1px);
}

.nav a:hover:not(.active) { 
  background: var(--bg-soft); 
  border-color: var(--card-border);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.nav a:active { 
  transform: translateY(0) scale(0.98); 
}

.nav .icon { 
  width: 20px; 
  height: 20px; 
  color: inherit;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Enhanced Main Content */
main { 
  grid-area: main; 
  padding: 24px; 
  min-height: 100vh;
  background: rgba(0,0,0,0.01);
}

/* Enhanced Floating Controls */
.floating {
  position: fixed; 
  top: 20px; 
  left: calc(var(--sidebar-w) + 20px);
  display: flex; 
  gap: 12px; 
  z-index: 15;
  transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

aside.collapsed + .floating { 
  left: calc(var(--sidebar-w-collapsed) + 20px); 
}

.fab {
  display: inline-flex; 
  align-items: center; 
  justify-content: center;
  width: 48px; 
  height: 48px; 
  border-radius: 16px; 
  background: var(--surface); 
  border: 1px solid var(--card-border);
  backdrop-filter: var(--blur); 
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.fab::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
  opacity: 0;
  transition: opacity 0.2s ease;
}

.fab:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: var(--shadow-lg);
  border-color: var(--accent-solid);
}

.fab:hover::before {
  opacity: 1;
}

.fab:active { 
  transform: translateY(0) scale(0.95); 
}

.fab:focus-visible { 
  outline: none; 
  box-shadow: var(--ring), var(--shadow-lg); 
}

/* Enhanced Grid System */
.grid { 
  display: grid; 
  gap: 20px; 
}

.grid.metrics { 
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
}

.grid.dash-main { 
  grid-template-columns: 1.8fr 1fr; 
  align-items: stretch; 
  gap: 24px;
}

.grid.leads { 
  grid-template-columns: 3fr 2fr; 
  gap: 24px;
}   

.grid.mem { 
  grid-template-columns: 1fr 1fr; 
  gap: 24px;
}     

@media (max-width: 1400px) {
  .grid.metrics { 
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
  }
  .grid.dash-main { 
    grid-template-columns: 1fr; 
  }
}

@media (max-width: 1000px) {
  .grid.leads, .grid.mem { 
    grid-template-columns: 1fr; 
  }
}

@media (max-width: 600px) {
  .grid.metrics { 
    grid-template-columns: 1fr; 
  }
}

/* Enhanced Cards */
.card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 20px;
  box-shadow: var(--shadow);
  overflow: hidden;
  animation: fadeUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  backdrop-filter: var(--blur);
}

.card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, transparent 50%);
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}

.card:hover { 
  transform: translateY(-4px); 
  box-shadow: var(--shadow-xl); 
  border-color: var(--accent-solid);
  background: var(--card-hover);
}

.card:hover::before {
  opacity: 1;
}

.card-header { 
  padding: 18px 20px; 
  font-size: 14px; 
  font-weight: 600;
  color: var(--text); 
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  border-bottom: 1px solid var(--card-border);
  background: rgba(0,0,0,0.02);
}

.card-body { 
  padding: 20px; 
}

.card.glow {
  animation: softPulse 4s ease-in-out infinite;
}

.card.glow::after {
  content: "";
  position: absolute;
  inset: -2px;
  background: var(--accent);
  border-radius: 20px;
  opacity: 0.1;
  z-index: -1;
  filter: blur(20px);
}

/* Enhanced Metrics */
.metric {
  display: flex; 
  align-items: end; 
  justify-content: space-between;
  font-weight: 700; 
  font-size: 2rem;
  color: var(--text);
  gap: 16px;
}

.metric .hint { 
  font-size: 12px; 
  color: var(--muted); 
  font-weight: 500; 
  text-align: right;
  line-height: 1.3;
}

/* Enhanced Form Elements */
.form-row { 
  display: grid; 
  gap: 10px; 
}

.label { 
  font-size: 13px; 
  color: var(--muted); 
  font-weight: 600;
  letter-spacing: 0.02em;
}

.input, .textarea, .select {
  width: 100%; 
  color: var(--text); 
  background: var(--bg-soft);
  border: 1px solid var(--card-border); 
  border-radius: 12px; 
  padding: 12px 16px;
  outline: none; 
  font-size: 14px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}

.textarea { 
  min-height: 120px; 
  resize: vertical; 
  line-height: 1.5;
}

.input:focus, .textarea:focus, .select:focus { 
  border-color: var(--accent-solid); 
  box-shadow: var(--ring); 
  background: var(--surface);
  transform: translateY(-1px);
}

.input:hover:not(:focus), .textarea:hover:not(:focus) { 
  transform: translateY(-1px);
  border-color: var(--muted);
}

.input::placeholder, .textarea::placeholder {
  color: var(--muted-soft);
}

/* Enhanced Segmented Control */
.segmented {
  display: inline-flex; 
  background: var(--bg-soft); 
  border: 1px solid var(--card-border); 
  border-radius: 12px; 
  padding: 6px;
  gap: 4px;
}

.segmented button {
  background: transparent; 
  border: 0; 
  color: var(--muted); 
  padding: 10px 16px; 
  border-radius: 8px; 
  cursor: pointer; 
  font-weight: 600;
  font-size: 13px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.segmented button.active { 
  background: var(--accent-solid); 
  color: white;
  box-shadow: var(--shadow-sm);
  transform: translateY(-1px);
}

.segmented button:hover:not(.active) {
  background: var(--surface);
  color: var(--text);
}

/* Enhanced Buttons */
.btn {
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  gap: 10px;
  height: 44px; 
  padding: 0 20px; 
  border-radius: 12px; 
  border: 1px solid var(--card-border);
  background: var(--bg-soft); 
  color: var(--text); 
  cursor: pointer; 
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.btn:hover::before {
  transform: translateX(100%);
}

.btn.primary { 
  background: var(--accent); 
  border-color: transparent; 
  color: white;
  box-shadow: var(--shadow-glow);
}

.btn.secondary { 
  background: var(--surface);
  border-color: var(--card-border);
}

.btn:active { 
  transform: translateY(1px) scale(0.98); 
}

.btn:hover { 
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn.primary:hover {
  box-shadow: var(--shadow-glow), var(--shadow-lg);
}

.btn:focus-visible { 
  outline: none; 
  box-shadow: var(--ring); 
}

/* Enhanced Badge */
.badge {
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  height: 28px;
  border-radius: 20px; 
  padding: 0 12px; 
  font-size: 12px; 
  font-weight: 600;
  border: 1px solid var(--card-border);
  background: var(--surface);
  color: var(--text);
  backdrop-filter: blur(10px);
}

/* Enhanced Tables */
table { 
  width: 100%; 
  border-collapse: collapse; 
}

th, td { 
  text-align: left; 
  padding: 16px 20px; 
  border-bottom: 1px solid var(--card-border); 
}

th { 
  font-size: 12px; 
  color: var(--muted); 
  font-weight: 700; 
  letter-spacing: 0.05em;
  text-transform: uppercase;
  background: var(--bg-soft);
}

tr {
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

tr:hover td { 
  background: var(--bg-soft); 
  color: var(--text);
}

tr.selected td { 
  background: var(--accent-solid); 
  color: white;
  border-color: var(--accent-solid);
}

/* Enhanced Modals */
.overlay {
  position: fixed; 
  inset: 0; 
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  display: none; 
  align-items: center; 
  justify-content: center; 
  padding: 20px; 
  z-index: 50;
}

.overlay.open { 
  display: flex; 
}

.modal {
  width: 100%; 
  max-width: 500px;
  background: var(--card); 
  border: 1px solid var(--card-border); 
  border-radius: 20px; 
  box-shadow: var(--shadow-xl);
  overflow: hidden; 
  animation: fadeUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) both;
  backdrop-filter: var(--blur);
}

.modal-header { 
  padding: 20px 24px; 
  border-bottom: 1px solid var(--card-border); 
  font-weight: 700; 
  font-size: 16px;
  background: var(--bg-soft);
}

.modal-body { 
  padding: 24px; 
}

.modal-actions { 
  display: flex; 
  gap: 12px; 
  justify-content: flex-end; 
  padding: 20px 24px; 
  border-top: 1px solid var(--card-border);
  background: var(--bg-soft);
}

/* Enhanced Charts */
.chart-wrap { 
  position: relative; 
  height: 380px;
  border-radius: 16px;
  overflow: hidden;
}

.chart { 
  width: 100%; 
  height: 380px;
  border-radius: 16px;
}

.legend { 
  display: flex; 
  gap: 20px; 
  flex-wrap: wrap; 
  align-items: center; 
  font-size: 13px; 
  color: var(--muted); 
  margin-top: 16px;
  font-weight: 500;
}

.dot { 
  width: 12px; 
  height: 12px; 
  border-radius: 50%; 
  display: inline-block;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.tooltip {
  position: absolute;
  pointer-events: none;
  background: var(--card);
  border: 1px solid var(--card-border);
  color: var(--text);
  border-radius: 12px;
  padding: 10px 14px;
  font-size: 12px;
  font-weight: 600;
  transform: translate(-50%, -120%);
  white-space: nowrap;
  box-shadow: var(--shadow-lg);
  backdrop-filter: var(--blur);
  display: none;
  z-index: 100;
}

/* Enhanced WhatsApp Indicator */
.wa-ind { 
  width: 12px; 
  height: 12px; 
  border-radius: 50%; 
  background: var(--muted-soft); 
  border: 2px solid var(--card-border);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.wa-ind.on { 
  background: var(--accent-2-solid); 
  border-color: var(--accent-2-solid);
  animation: softPulse 3s ease-in-out infinite;
  box-shadow: 0 0 16px rgba(72, 187, 120, 0.5);
}

/* Enhanced Lead Profile */
.lead-profile { 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  gap: 20px; 
  padding: 32px 20px; 
  text-align: center;
}

.lead-avatar {
  width: 120px; 
  height: 120px; 
  border-radius: 50%;
  background: var(--bg-soft); 
  border: 3px solid var(--card-border);
  display: grid; 
  place-items: center; 
  overflow: hidden; 
  position: relative; 
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow);
}

.lead-avatar:hover {
  transform: scale(1.05);
  border-color: var(--accent-solid);
  box-shadow: var(--shadow-lg);
}

.lead-avatar img { 
  width: 100%; 
  height: 100%; 
  object-fit: cover; 
}

.lead-avatar::after { 
  content: ''; 
  position: absolute; 
  inset: 0; 
  border-radius: 50%; 
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1); 
}

.lead-info { 
  display: grid; 
  gap: 12px; 
  text-align: center; 
  max-width: 280px;
}

.lead-name { 
  font-size: 20px; 
  font-weight: 700; 
  color: var(--text);
}

.lead-phone { 
  font-size: 15px; 
  color: var(--muted); 
  font-weight: 500;
}

.lead-dates { 
  display: grid; 
  gap: 6px; 
  font-size: 13px; 
  color: var(--muted-soft);
  line-height: 1.4;
}

/* Enhanced Filters Bar */
.filters-bar {
  display: flex; 
  align-items: center; 
  gap: 16px;
  margin-top: 20px;
  padding: 16px 20px;
  background: var(--surface);
  border: 1px solid var(--card-border);
  border-radius: 16px;
  backdrop-filter: var(--blur);
}

/* Enhanced Responsive Design */
@media (max-width: 1200px) {
  main { padding: 20px; }
  .floating { top: 16px; left: 16px !important; }
}

@media (max-width: 900px) {
  .app { 
    grid-template-columns: 1fr; 
    grid-template-areas: "main"; 
  }
  
  aside { 
    position: fixed; 
    inset: 0 30% 0 0; 
    transform: translateX(-100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    z-index: 30; 
  }
  
  aside.open { 
    transform: translateX(0%); 
  }
  
  .nav a { 
    padding: 16px 20px; 
    margin: 6px 0;
  }
  
  .fab { 
    width: 44px; 
    height: 44px; 
  }
  
  main { 
    padding: 16px; 
  }
  
  .floating {
    top: 16px;
    left: 16px !important;
  }
}

@media (max-width: 600px) {
  .grid { gap: 16px; }
  .card-body { padding: 16px; }
  .card-header { padding: 14px 16px; }
  
  .metric {
    font-size: 1.5rem;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .btn {
    height: 40px;
    padding: 0 16px;
    font-size: 13px;
  }
  
  .modal {
    margin: 16px;
    max-width: calc(100vw - 32px);
  }
  
  aside {
    inset: 0 20% 0 0;
  }
}

/* Enhanced Sections */
section { 
  display: none;
  animation: fadeUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
}

section.active { 
  display: block; 
}

/* Enhanced Toast */
.toast {
  position: fixed; 
  right: 24px; 
  bottom: 24px; 
  z-index: 60;
  background: var(--card); 
  border: 1px solid var(--card-border); 
  border-radius: 16px; 
  padding: 16px 20px;
  box-shadow: var(--shadow-xl); 
  backdrop-filter: var(--blur);
  opacity: 0; 
  transform: translateY(20px);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-weight: 500;
  max-width: 400px;
}

.toast.show { 
  opacity: 1; 
  transform: translateY(0); 
}

/* Enhanced Scrollbars */
* { 
  scrollbar-width: thin; 
  scrollbar-color: rgba(102, 126, 234, 0.3) transparent; 
}

*::-webkit-scrollbar { 
  width: 8px; 
  height: 8px; 
}

*::-webkit-scrollbar-track {
  background: transparent;
}

*::-webkit-scrollbar-thumb { 
  background: rgba(102, 126, 234, 0.3); 
  border-radius: 20px;
  transition: background 0.2s ease;
}

*::-webkit-scrollbar-thumb:hover { 
  background: rgba(102, 126, 234, 0.5); 
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  
  .ambient {
    animation: none !important;
  }
}

/* Enhanced WhatsApp Connected Message */
.wa-connected {
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-size: 18px;
  font-weight: 600;
  color: var(--accent-2-solid);
  padding: 80px 32px;
  border: 2px dashed var(--accent-2-solid);
  border-radius: 20px;
  background: linear-gradient(135deg, rgba(72, 187, 120, 0.05), rgba(72, 187, 120, 0.02));
  backdrop-filter: blur(10px);
  animation: softPulse 4s ease-in-out infinite;
}

/* Enhanced Focus States */
.nav a:focus-visible,
.segmented button:focus-visible,
.input:focus-visible,
.textarea:focus-visible,
.btn:focus-visible {
  outline: none;
  box-shadow: var(--ring);
}

/* Enhanced Safe Area */
main {
  padding: 24px env(safe-area-inset-right) calc(24px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
}

.floating { 
  top: calc(20px + env(safe-area-inset-top)); 
}

/* Print Styles */
@media print {
  .floating,
  aside,
  .ambient {
    display: none !important;
  }
  
  .app {
    grid-template-columns: 1fr !important;
  }
  
  .card {
    break-inside: avoid;
    box-shadow: none !important;
    border: 1px solid #ddd !important;
  }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
  :root {
    --card-border: rgba(255,255,255,0.3);
    --text: #ffffff;
    --muted: #cccccc;
  }
  
  html.light {
    --card-border: rgba(0,0,0,0.3);
    --text: #000000;
    --muted: #333333;
  }
}

/* Loading States */
.loading {
  position: relative;
  overflow: hidden;
}

.loading::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(255,255,255,0.1),
    transparent
  );
  animation: shimmer 2s infinite;
}
</style>
</head>
<body>
<div class="ambient" aria-hidden="true"></div>

<div class="app">
<!-- Enhanced Sidebar -->
<aside id="sidebar" aria-label="Navega√ß√£o lateral">
  <nav class="nav">
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path d="M12 3l9 4.5v9L12 21 3 16.5v-9L12 3z" stroke-width="2"/>
        <circle cx="12" cy="12" r="3" stroke-width="2"/>
      </svg>
      <span class="label">CRM</span>
    </div>
    
    <a href="#dashboard" data-link class="active" aria-label="Dashboard">
      <span class="icon">üìä</span>
      <span class="label">Dashboard</span>
    </a>
    <a href="#leads" data-link aria-label="Leads">
      <span class="icon">üë•</span>
      <span class="label">Leads</span>
    </a>
    <a href="#disparo" data-link aria-label="Disparo">
      <span class="icon">üì®</span>
      <span class="label">Disparo</span>
    </a>
    
    <a href="#whatsapp" data-link aria-label="WhatsApp">
      <span class="icon">üí¨</span>
      <span class="label">WhatsApp</span>
    </a>
    
    <a href="#memoria" data-link aria-label="Mem√≥ria">
      <span class="icon">üß†</span>
      <span class="label">Mem√≥ria IA</span>
    </a>
  </nav>
</aside>

<!-- Enhanced Floating Controls -->
<div class="floating" aria-hidden="false">
  <button id="toggleSidebar" class="fab" title="Abrir/fechar menu" aria-label="Abrir/fechar menu">‚ò∞</button>
  <button id="toggleTheme" class="fab" title="Tema claro/escuro" aria-label="Tema claro/escuro">üåì</button>
</div>

<!-- Enhanced Main Content -->
<main id="main">
  <!-- Dashboard Section -->
  <section id="dashboard" class="active" aria-label="Dashboard">
    <!-- Enhanced Metrics Grid -->
    <div class="grid metrics">
      <div class="card">
        <div class="card-header">
          <span>Total de Leads</span>
          <span>üìà</span>
        </div>
        <div class="card-body">
          <div class="metric">
            <span id="m-leads">0</span>
            <span class="hint" id="m-leads-hint">leads cadastrados</span>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span>Mensagens Enviadas</span>
          <span>üì§</span>
        </div>
        <div class="card-body">
          <div class="metric">
            <span id="m-sent">0</span>
            <span class="hint" id="m-sent-hint">mensagens hoje</span>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span>Tempo de Resposta</span>
          <span>‚ö°</span>
        </div>
        <div class="card-body">
          <div class="metric">
            <span id="m-response">0seg</span>
            <span class="hint" id="m-response-hint">tempo m√©dio</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Charts Section -->
    <div class="grid dash-main" style="margin-top: 24px;">
      <!-- Enhanced Hourly Activity Chart -->
      <div class="card glow">
        <div class="card-header">
          <span>Atividade por Hor√°rio</span>
          <span>üïê</span>
        </div>
        <div class="card-body">
          <div class="chart-wrap" id="hourly-wrap">
            <canvas id="hourlyChart" class="chart" aria-label="Gr√°fico de atividade por hora"></canvas>
            <div id="chart-tooltip" class="tooltip" role="tooltip"></div>
          </div>
          <div class="legend">
            <span class="dot" style="background: linear-gradient(135deg, #667eea, #764ba2);"></span>
            <span>Atividade total por hora</span>
          </div>
        </div>
      </div>

      <!-- Enhanced Donut Chart -->
      <div class="card glow">
        <div class="card-header">
          <span>Distribui√ß√£o de Leads</span>
        </div>
        <div class="card-body">
          <div style="display: flex; gap: 20px; align-items: center; justify-content: center; flex-wrap: wrap;">
            <svg id="donut" width="200" height="200" viewBox="0 0 180 180" style="animation: glow 4s ease-in-out infinite;">
              <defs>
                <linearGradient id="newGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#667eea"/>
                  <stop offset="100%" style="stop-color:#764ba2"/>
                </linearGradient>
                <linearGradient id="oldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#94a3b8"/>
                  <stop offset="100%" style="stop-color:#64748b"/>
                </linearGradient>
              </defs>
              <circle cx="90" cy="90" r="64" fill="none" stroke="var(--card-border)" stroke-width="24"></circle>
              <circle id="slice1" cx="90" cy="90" r="64" fill="none" stroke="url(#newGradient)" stroke-width="24" transform="rotate(-90 90 90)" stroke-dasharray="0 402" stroke-linecap="round"></circle>
              <circle id="slice2" cx="90" cy="90" r="64" fill="none" stroke="url(#oldGradient)" stroke-width="24" transform="rotate(-90 90 90)" stroke-dasharray="0 402" stroke-linecap="round"></circle>
              <g>
                <circle cx="90" cy="90" r="44" fill="var(--card)" stroke="var(--card-border)" stroke-width="1"></circle>
                <text id="donut-center" x="90" y="86" text-anchor="middle" font-size="20" font-weight="700" fill="var(--text)">0%</text>
                <text x="90" y="106" text-anchor="middle" font-size="12" fill="var(--muted)">Novos</text>
              </g>
            </svg>
            <div style="display: grid; gap: 16px; min-width: 200px;">
              <div class="legend">
                <span class="dot" style="background: linear-gradient(135deg, #667eea, #764ba2);"></span>
                <span>Leads Novos: <strong id="lg-new">0%</strong></span>
              </div>
              <div class="legend">
                <span class="dot" style="background: linear-gradient(135deg, #94a3b8, #64748b);"></span>
                <span>Leads Antigos: <strong id="lg-old">0%</strong></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Filters Bar -->
    <div class="filters-bar" aria-label="Filtros de per√≠odo">
      <span class="label">üìÖ Per√≠odo de an√°lise</span>
      <div class="segmented" role="tablist" aria-label="Per√≠odo">
        <button data-range="1" class="active" role="tab" aria-selected="true">Hoje</button>
        <button data-range="7" role="tab" aria-selected="false">7 dias</button>
      </div>
    </div>
  </section>

  <!-- Enhanced Leads Section -->
  <section id="leads" aria-label="Gest√£o de Leads">
    <div class="grid leads">
      <!-- Enhanced Leads List -->
      <div class="card">
        <div class="card-header">
          <span>üìã Lista de Leads</span>
          <span class="badge" id="leads-count">0 leads</span>
        </div>
        <div class="card-body">
          <div class="form-row" style="margin-bottom: 16px;">
            <input id="lead-search" class="input" placeholder="üîç Buscar por nome ou telefone..." />
          </div>
          <div class="card" style="overflow: auto; max-height: 500px;">
            <div class="card-body" style="padding: 0;">
              <table>
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Primeiro Contato</th>
                    <th>√öltima Mensagem</th>
                  </tr>
                </thead>
                <tbody id="leads-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Lead Profile -->
      <div class="card">
        <div class="card-header">
          <span>üë§ Perfil do Lead</span>
          <span id="lead-status" class="badge" style="display: none;">Online</span>
        </div>
        <div class="card-body">
          <div id="lead-profile" class="lead-profile">
            <div class="lead-avatar">
              <img id="lead-avatar-img" style="display: none;" alt="Foto do lead" />
              <svg id="lead-avatar-ph" viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" style="color: var(--muted);">
                <path d="M12 12c2.761 0 5-2.239 5-5S14.761 2 12 2 7 4.239 7 7s2.239 5 5 5Zm0 2c-3.866 0-7 3.134-7 7h14c0-3.866-3.134-7-7-7Z" stroke-width="1.5"/>
              </svg>
            </div>
            <div class="lead-info">
              <div id="lead-profile-name" class="lead-name">Selecione um lead</div>
              <div id="lead-profile-phone" class="lead-phone"></div>
              <div class="lead-dates">
                <div id="lead-profile-first"></div>
                <div id="lead-profile-last"></div>
              </div>
            </div>
            <button id="lead-edit" class="btn secondary" style="display: none;">
              ‚úèÔ∏è Editar Lead
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Enhanced Disparo Section -->
  <section id="disparo" aria-label="Envio de Mensagens">
    <div class="grid" style="grid-template-columns: 1.4fr 0.6fr; gap: 24px;">
      <!-- Enhanced Message Composer -->
      <div class="card">
        <div class="card-header">
          <span>üì® Criar Disparo</span>
          <span class="badge">Nova mensagem</span>
        </div>
        <div class="card-body">
          <div class="form-row" style="margin-bottom: 20px;">
            <label class="label" for="msg">Mensagem</label>
            <textarea id="msg" class="textarea" placeholder="Digite sua mensagem aqui..." style="min-height: 120px;"></textarea>
          </div>
          
          <div class="form-row" style="margin-bottom: 20px;">
            <span class="label">üéØ Destinat√°rios</span>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 8px;">
              <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                <input type="radio" name="destino" value="todos" checked style="accent-color: var(--accent-solid);" /> 
                <span>Todos os leads</span>
              </label>
              <label style="display: flex; gap: 8px; align-items: center; cursor: pointer;">
                <input type="radio" name="destino" value="selecionar" style="accent-color: var(--accent-solid);" /> 
                <span>Selecionar espec√≠ficos</span>
              </label>
            </div>
          </div>
          
          <div id="select-leads" class="card" style="display: none;">
            <div class="card-body">
              <div class="form-row" style="margin-bottom: 12px;">
                <input id="lead-filter" class="input" placeholder="üîç Filtrar leads..." />
              </div>
              <div id="lead-checklist" style="max-height: 200px; overflow: auto; display: grid; gap: 10px;"></div>
            </div>
          </div>

          <!-- Enhanced Scheduling -->
          <div class="form-row" style="margin: 20px 0;">
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="checkbox" id="schedule-check" style="accent-color: var(--accent-solid);" />
              <label for="schedule-check" class="label" style="margin: 0; cursor: pointer;">‚è∞ Agendar envio</label>
            </div>
            <div id="schedule-options" style="display: none; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
              <div class="form-row">
                <label class="label" for="schedule-date">üìÖ Data</label>
                <input type="date" id="schedule-date" class="input" />
              </div>
              <div class="form-row">
                <label class="label" for="schedule-time">üïí Hor√°rio</label>
                <input type="time" id="schedule-time" class="input" />
              </div>
            </div>
          </div>

          <div style="margin-top: 24px;">
            <button id="send" class="btn primary">
              Enviar Disparo
            </button>
          </div>
        </div>
      </div>

      <!-- Enhanced History -->
      <div class="card">
        <div class="card-header">
          <span>Hist√≥rico</span>
          <span class="badge" id="history-count">0 disparos</span>
        </div>
        <div class="card-body">
          <div id="send-history" style="display: grid; gap: 12px; max-height: 600px; overflow: auto;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Enhanced WhatsApp Section -->
  <section id="whatsapp" aria-label="Conex√£o WhatsApp">
    <div class="card glow">
      <div class="card-header">
        <span>Conex√£o WhatsApp</span>
        <span style="display: inline-flex; align-items: center; gap: 12px;">
          <span class="wa-ind" id="wa-ind"></span>
          <span id="wa-label" class="badge">Offline</span>
        </span>
      </div>
      <div class="card-body">
        <div class="grid" style="grid-template-columns: 2fr 1fr; align-items: start; gap: 32px;">
          <!-- Enhanced QR Code Area -->
          <div style="display: flex; justify-content: center;">
            <div id="qr" style="width: 100%; max-width: 400px; aspect-ratio: 1/1; border-radius: 20px; border: 2px solid var(--card-border); background:
                linear-gradient(45deg, rgba(255,255,255,0.03) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.03) 50%, rgba(255,255,255,0.03) 75%, transparent 75%, transparent) 0 0/32px 32px,
                linear-gradient(-45deg, rgba(255,255,255,0.03) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.03) 50%, rgba(255,255,255,0.03) 75%, transparent 75%, transparent) 0 0/32px 32px,
                var(--bg-soft);
                box-shadow: var(--shadow);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                ">
            </div>
            <div id="wa-connected" class="wa-connected" style="display: none; width: 100%; max-width: 400px;">
              ‚úÖ WhatsApp Conectado com Sucesso!
            </div>
          </div>
          
          <!-- Enhanced Actions -->
          <div class="form-row" style="gap: 16px;">
            <button id="wa-refresh" class="btn secondary">
              üîÑ Atualizar QR Code
            </button>
            <div style="padding: 16px; background: var(--bg-soft); border-radius: 12px; border: 1px solid var(--card-border);">
              <h4 style="margin-bottom: 8px; color: var(--text);">üì± Como Conectar</h4>
              <ol style="font-size: 13px; color: var(--muted); line-height: 1.5; margin: 0; padding-left: 20px;">
                <li>Abra o WhatsApp no seu telefone</li>
                <li>Toque em "Mais op√ß√µes" (‚ãÆ) e depois "Aparelhos conectados"</li>
                <li>Toque em "Conectar um aparelho"</li>
                <li>Aponte a c√¢mera para o QR code acima</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Enhanced Memoria Section -->
  <section id="memoria" aria-label="Mem√≥ria da IA">
    <div class="grid mem">
      <!-- Enhanced Knowledge Form -->
      <div class="card">
        <div class="card-header">
          <span>üß† Adicionar Conhecimento</span>
          <span class="badge">Nova mem√≥ria</span>
        </div>
        <div class="card-body">
          <div class="form-row" style="margin-bottom: 20px;">
            <label class="label" for="q">‚ùì Pergunta</label>
            <textarea id="q" class="textarea" placeholder="Ex.: Qual o hor√°rio de atendimento?" style="min-height: 80px;"></textarea>
          </div>
          <div class="form-row" style="margin-bottom: 20px;">
            <label class="label" for="a">üí° Resposta</label>
            <textarea id="a" class="textarea" placeholder="Ex.: Segunda a sexta, das 9h √†s 18h." style="min-height: 100px;"></textarea>
          </div>
          <button id="mem-add" class="btn primary">
            ‚ûï Adicionar Mem√≥ria
          </button>
        </div>
      </div>

      <!-- Enhanced Memory List -->
      <div class="card">
        <div class="card-header">
          <span>Mem√≥rias Cadastradas</span>
          <span class="badge" id="memory-count">0 mem√≥rias</span>
        </div>
        <div class="card-body">
          <div class="form-row" style="margin-bottom: 16px;">
            <input id="mem-filter" class="input" placeholder="üîç Filtrar mem√≥rias..." />
          </div>
          <div id="mem-list" style="max-height: 500px; overflow: auto; display: grid; gap: 12px;"></div>
        </div>
      </div>
    </div>
  </section>
</main>
</div>

<!-- Enhanced Lead Modal -->
<div class="overlay" id="lead-modal" role="dialog" aria-modal="true" aria-labelledby="lead-modal-title">
<div class="modal">
  <div class="modal-header" id="lead-modal-title">‚úèÔ∏è Editar Lead</div>
  <div class="modal-body">
    <div class="form-row" style="margin-bottom: 16px;">
      <label class="label" for="lead-name">üë§ Nome completo</label>
      <input id="lead-name" class="input" placeholder="Digite o nome completo" />
    </div>
    <div class="form-row" style="margin-bottom: 16px;">
      <label class="label" for="lead-phone">üì± N√∫mero de telefone</label>
      <input id="lead-phone" class="input" placeholder="(00) 00000-0000" />
    </div>
    <div class="form-row">
      <label class="label" for="lead-first">üìÖ Data e hora do primeiro contato</label>
      <input id="lead-first" type="datetime-local" class="input" />
    </div>
  </div>
  <div class="modal-actions">
    <button class="btn" id="lead-cancel">Cancelar</button>
    <button class="btn primary" id="lead-save">üíæ Salvar</button>
  </div>
</div>
</div>

<!-- Enhanced Memory Edit Modal -->
<div class="overlay" id="mem-modal" role="dialog" aria-modal="true" aria-labelledby="mem-modal-title">
<div class="modal">
  <div class="modal-header" id="mem-modal-title">üß† Editar Mem√≥ria</div>
  <div class="modal-body">
    <div class="form-row" style="margin-bottom: 20px;">
      <label class="label" for="mem-edit-q">‚ùì Pergunta</label>
      <textarea id="mem-edit-q" class="textarea" style="min-height: 80px;"></textarea>
    </div>
    <div class="form-row">
      <label class="label" for="mem-edit-a">üí° Resposta</label>
      <textarea id="mem-edit-a" class="textarea" style="min-height: 100px;"></textarea>
    </div>
  </div>
  <div class="modal-actions">
    <button class="btn" id="mem-cancel">Cancelar</button>
    <button class="btn primary" id="mem-save">üíæ Salvar</button>
  </div>
</div>
</div>

<!-- Enhanced Toast -->
<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
// ====== MANTIDO TODO O JAVASCRIPT ORIGINAL ======
// ====== CONSTS / HELPERS (INTEGRA√á√ÉO API) ======
const qs = (s, el = document) => el.querySelector(s);
const qsa = (s, el = document) => Array.from(el.querySelectorAll(s));
function toast(msg) {
  const el = qs('#toast'); el.textContent = msg; el.classList.add('show');
  clearTimeout(el._t); el._t = setTimeout(() => el.classList.remove('show'), 2200);
}

const BASE_URL = "https://wbhk.joaoavelar.space/webhook";
const ENDPOINT = `${BASE_URL}/api/sync`;

async function apiRequest(path, method = 'GET', data = null) {
  try {
    const config = { method, headers: { 'Content-Type': 'application/json' } };
    if (data && method !== 'GET') config.body = JSON.stringify(data);
    const url = path.startsWith('http') ? path : `${BASE_URL}${path}`;
    const response = await fetch(url, config);
    return await response.json();
  } catch (error) {
    console.error('API Error:', error);
    toast('Erro de conex√£o');
    return { success: false, error: error.message };
  }
}

function buildPayload() {
  return {
    ui: {
      theme: document.documentElement.classList.contains('light') ? 'light' : 'dark',
      sidebarCollapsed: !document.querySelector('#sidebar')?.classList.contains('open') && document.querySelector('#sidebar')?.classList.contains('collapsed'),
      currentSection: (location.hash || '#dashboard').replace('#','') || 'dashboard',
    },
    rangeDays: state.rangeDays,
    metrics: state.metrics,
    hourly: state.hourly,
    leads: state.leads,
    activeLeadId: state.activeLead?.id ?? null,
    history: state.history,
    whatsapp: state.whatsapp,
    memoria: state.memoria,
    timestamp: new Date().toISOString()
  }
}
async function sendAll(endpoint = ENDPOINT) {
  try {
    const res = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(buildPayload())
    });
    // mant√©m estrutura; sem logs extras de disparo
  } catch (err) {
    console.warn('sendAll error', err);
  }
}

// ====== THEME / SIDEBAR ======
const html = document.documentElement;
function applyTheme(saved) {
  const theme = saved ?? localStorage.getItem('theme') ?? 'dark';
  html.classList.toggle('light', theme === 'light');
  localStorage.setItem('theme', theme);
}
function toggleTheme() { applyTheme(html.classList.contains('light') ? 'dark' : 'light'); }

const sidebar = qs('#sidebar');
function setSidebarCollapsed(collapsed) {
  if (window.innerWidth <= 900) {
    sidebar.classList.toggle('open', !collapsed);
  } else {
    sidebar.classList.toggle('collapsed', collapsed);
    localStorage.setItem('sidebar-collapsed', collapsed ? '1' : '0');
  }
}
function toggleSidebar() {
  if (window.innerWidth <= 900) sidebar.classList.toggle('open');
  else setSidebarCollapsed(!sidebar.classList.contains('collapsed'));
}

// ====== STATE ======
const state = {
  rangeDays: 1,
  metrics: { leads: 0, leadsHint: "", sent: 0, sentHint: "", responseTime: 0, responseHint: "" },
  hourly: Array.from({length: 24}, () => 0),
  leads: [],
  activeLead: null,
  history: [],
  whatsapp: { status: "offline", qrSeed: 0, qr: null },
  memoria: [],
  memEdit: null,
};

// ====== UTILITIES / GENERATORS (mantidos p/ UI) ======
function baseHourValue(h, factor=1) {
  const work = (h >= 9 && h <= 18) ? 1 : 0.35;
  const lunch = (h === 12 || h === 13) ? -0.25 : 0;
  const v = Math.max(0, work + lunch) + (Math.sin(h/2)+1)/6;
  return Math.round((v * 12 * factor));
}
function computePie() {
  const todayStart = new Date(); todayStart.setHours(0,0,0,0);
  const total = state.leads.length || 1;
  const newLeads = state.leads.filter(l => new Date(l.primeiroContato) >= todayStart).length;
  const pctNew = Math.round(newLeads / total * 100);
  const pctOld = 100 - pctNew;
  return { pctNew, pctOld };
}
const CHART_HEIGHT = 380;
function sizeCanvasToDevice(canvas, cssW, cssH) {
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  canvas.style.width = cssW + 'px';
  canvas.style.height = cssH + 'px';
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  return dpr;
}

// ====== RENDER: M√âTRICAS / CHARTS / DONUT ======
function renderMetrics() {
  qs('#m-leads').textContent = state.metrics.leads?.toLocaleString?.('pt-BR') ?? '0';
  qs('#m-sent').textContent = state.metrics.sent?.toLocaleString?.('pt-BR') ?? '0';
  qs('#m-response').textContent = (state.metrics.responseTime ?? 0) + 'seg';
  qs('#m-leads-hint').textContent = state.metrics.leadsHint || '';
  qs('#m-sent-hint').textContent = state.metrics.sentHint || '';
  qs('#m-response-hint').textContent = state.metrics.responseHint || '';
}

function renderHourlyChart() {
  const canvas = qs('#hourlyChart');
  const wrap = qs('#hourly-wrap');
  const tip = qs('#chart-tooltip');
  const rect = wrap.getBoundingClientRect();
  const dpr = sizeCanvasToDevice(canvas, Math.max(600, Math.floor(rect.width)), CHART_HEIGHT);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  const w = canvas.width / dpr, h = canvas.height / dpr;
  const pad = 32;

  // Clear
  ctx.clearRect(0,0,w,h);

  // Enhanced Grid
  ctx.strokeStyle = 'rgba(102, 126, 234, 0.1)';
  ctx.lineWidth = 1;
  for (let i=0;i<=5;i++) {
    const y = pad + ((h - pad*2) * i / 5);
    ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w - pad, y); ctx.stroke();
  }
  for (let i=0;i<=8;i++) {
    const x = pad + ((w - pad*2) * i / 8);
    ctx.beginPath(); ctx.moveTo(x, pad); ctx.lineTo(x, h - pad); ctx.stroke();
  }

  // Enhanced Labels
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
  ctx.font = '11px Inter, sans-serif';
  ctx.textAlign = 'center';
  for (let i=0;i<=8;i++) {
    const hour = i * 3;
    const x = pad + ((w - pad*2) * i / 8);
    ctx.fillText(hour + 'h', x, h - 10);
  }

  // Enhanced Bars with gradients
  const max = Math.max(1, ...state.hourly);
  const innerW = w - pad*2;
  const barW = innerW / 24 * 0.8;
  const step = innerW / 24;

  for (let i=0;i<24;i++) {
    const x = pad + i * step + (step - barW)/2;
    const val = state.hourly[i];
    const barH = (val/max) * (h - pad*2);
    const y = h - pad - barH;

    const isBiz = i >= 9 && i <= 18;
    const grd = ctx.createLinearGradient(0, y, 0, y + barH);
    if (isBiz) { 
      grd.addColorStop(0, 'rgba(102, 126, 234, 0.9)'); 
      grd.addColorStop(1, 'rgba(118, 75, 162, 0.4)'); 
    }
    else { 
      grd.addColorStop(0, 'rgba(148, 163, 184, 0.7)'); 
      grd.addColorStop(1, 'rgba(100, 116, 139, 0.3)'); 
    }

    ctx.fillStyle = grd;
    ctx.fillRect(x, y, barW, barH);
    
    // Enhanced glow effect
    ctx.fillStyle = 'rgba(255,255,255,0.1)';
    ctx.fillRect(x, y, barW, 3);
    
    // Add subtle shadow
    ctx.fillStyle = 'rgba(0,0,0,0.1)';
    ctx.fillRect(x, y + barH - 2, barW, 2);
  }

  // Enhanced Tooltip
  wrap.onmousemove = (evt) => {
    const r = canvas.getBoundingClientRect();
    const mx = (evt.clientX - r.left);
    const my = (evt.clientY - r.top);
    if (mx < pad || mx > w - pad || my < pad || my > h - pad) { 
      tip.style.display = 'none'; 
      canvas.style.cursor = 'default';
      return; 
    }
    const relX = mx - pad;
    let idx = Math.floor(relX / step);
    if (idx < 0) idx = 0; if (idx > 23) idx = 23;
    const val = state.hourly[idx];
    tip.innerHTML = `<strong>${idx}h</strong><br/>${val} mensagens`;
    tip.style.display = 'block';
    tip.style.left = `${evt.clientX}px`;
    tip.style.top = `${evt.clientY - 10}px`;
    canvas.style.cursor = 'pointer';
  };
  wrap.onmouseleave = () => { 
    tip.style.display = 'none'; 
    canvas.style.cursor = 'default';
  };
}

function renderDonut({ pctNew, pctOld }) {
  const c = 2 * Math.PI * 64;
  const s1 = qs('#slice1'), s2 = qs('#slice2');
  const d1 = (pctNew/100) * c;
  const d2 = (pctOld/100) * c;
  
  // Anima√ß√£o suave do donut
  s1.style.transition = 'stroke-dasharray 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
  s2.style.transition = 'stroke-dasharray 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
  
  s1.setAttribute('stroke-dasharray', `${d1} ${c - d1}`);
  s1.setAttribute('stroke-dashoffset', '0');
  s2.setAttribute('stroke-dasharray', `${d2} ${c - d2}`);
  s2.setAttribute('stroke-dashoffset', `${-d1}`);
  qs('#donut-center').textContent = `${pctNew}%`;
  qs('#lg-new').textContent = `${pctNew}%`;
  qs('#lg-old').textContent = `${pctOld}%`;
}

// ====== LEADS ======
async function renderLeads() {
  const term = (qs("#lead-search").value || "").toLowerCase();
  
  if (state.leads.length === 0) {
    const res = await apiRequest(`/leads?search=${encodeURIComponent(term)}&page=1&limit=50`);
    if (res?.success) {
      state.leads = res.data || res.items || [];
    }
  }
  
  const filteredLeads = state.leads.filter(l => {
    if (!term) return true;
    const searchText = `${l.nome} ${l.telefone}`.toLowerCase();
    return searchText.includes(term);
  });
  
  const prevActive = state.activeLead?.id || null;
  const tbody = qs("#leads-body");
  tbody.innerHTML = filteredLeads.map(l => `
    <tr data-id="${l.id}" tabindex="0" role="button" style="animation: slideInRight 0.3s ease both; animation-delay: ${Math.random() * 0.2}s;">
      <td><strong>${l.nome}</strong></td>
      <td>${l.telefone}</td>
      <td>${fmtDateTime(l.primeiroContato)}</td>
      <td>${fmtDateTime(l.ultimaMensagem)}</td>
    </tr>
  `).join("");
  
  // Update leads count
  const leadsCount = qs('#leads-count');
  if (leadsCount) leadsCount.textContent = `${filteredLeads.length} leads`;
  
  qsa("#leads-body tr").forEach(tr => {
    tr.addEventListener("click", () => selectLead(tr.getAttribute("data-id")));
    tr.addEventListener("keydown", (e) => { if (e.key === "Enter") selectLead(tr.getAttribute("data-id")); });
  });
  
  if (prevActive && state.leads.some(l => l.id == prevActive)) {
    selectLead(prevActive);
  }
  renderDonut(computePie());
}

function selectLead(id) {
  const lead = state.leads.find(l => l.id == id);
  if (!lead) return;
  state.activeLead = lead;
  
  qsa("#leads-body tr").forEach(tr => tr.classList.remove("selected"));
  const selectedRow = qs(`#leads-body tr[data-id="${id}"]`);
  if (selectedRow) selectedRow.classList.add("selected");
  
  qs("#lead-profile-name").textContent = lead.nome || "Nome n√£o dispon√≠vel";
  qs("#lead-profile-phone").textContent = lead.telefone || "Telefone n√£o dispon√≠vel";
  qs("#lead-profile-first").textContent = `üìÖ Primeiro contato: ${fmtDateTime(lead.primeiroContato)}`;
  qs("#lead-profile-last").textContent = `üí¨ √öltima mensagem: ${fmtDateTime(lead.ultimaMensagem)}`;
  const img = qs("#lead-avatar-img");
  const ph = qs("#lead-avatar-ph");
  if (lead.foto) { 
    img.src = lead.foto; 
    img.style.display = "block"; 
    ph.style.display = "none"; 
  } else { 
    img.style.display = "none"; 
    ph.style.display = "block"; 
  }
  qs("#lead-edit").style.display = "inline-flex";
}

function fmtDateTime(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
}

// Lead modal
let activeLeadId = null;
function openLeadModal() {
  if (!state.activeLead) return;
  activeLeadId = state.activeLead.id;
  const lead = state.activeLead;
  qs('#lead-name').value = lead.nome || '';
  qs('#lead-phone').value = lead.telefone || '';
  qs('#lead-first').value = toLocalInput(lead.primeiroContato);
  qs('#lead-modal').classList.add('open');
}
function toLocalInput(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  const off = d.getTimezoneOffset();
  const local = new Date(d.getTime() - off*60000);
  return local.toISOString().slice(0,16);
}
function closeLeadModal() { qs('#lead-modal').classList.remove('open'); activeLeadId = null; }

async function saveLeadModal() {
  if (!activeLeadId) return;
  const body = {
    id: activeLeadId,
    nome: qs('#lead-name').value.trim(),
    telefone: qs('#lead-phone').value.trim(),
    primeiroContato: (() => {
      const dt = qs('#lead-first').value;
      if (!dt) return null;
      const d = new Date(dt);
      return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString();
    })()
  };
  const res = await apiRequest(`/leads/update`, 'PUT', body);
  if (res?.success) {
    const updated = res.data || { id: activeLeadId, ...body };
    const idx = state.leads.findIndex(l => l.id === activeLeadId);
    if (idx > -1) state.leads[idx] = { ...state.leads[idx], ...updated };
    await renderLeads();
    selectLead(updated.id);
    closeLeadModal();
    toast('‚úÖ Lead salvo com sucesso');
  } else {
    toast('‚ùå Erro ao salvar lead');
  }
}

// ====== DISPARO ======
function renderDisparoChecklist() {
  const filter = (qs('#lead-filter').value || '').toLowerCase();
  const list = state.leads.filter(l => (l.nome + ' ' + l.telefone).toLowerCase().includes(filter));
  const wrap = qs('#lead-checklist');
  wrap.innerHTML = list.map(l => `
      <label style="display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;transition:background 0.2s ease;cursor:pointer;" class="checklist-item">
        <input type="checkbox" value="${l.id}" style="accent-color: var(--accent-solid);" />
        <div>
          <div style="font-weight:600">${l.nome}</div>
          <div style="color:var(--muted);font-size:12px">${l.telefone}</div>
        </div>
      </label>
    `).join('');
  qsa('#lead-checklist input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
  
  // Add hover effects
  qsa('.checklist-item').forEach(item => {
    item.addEventListener('mouseenter', () => {
      item.style.background = 'var(--bg-soft)';
    });
    item.addEventListener('mouseleave', () => {
      item.style.background = 'transparent';
    });
  });
}

async function enviarDisparo() {
  const txt = qs('#msg').value.trim();
  if (!txt) { toast('‚ùå Digite uma mensagem'); return; }
  const mode = qsa('input[name="destino"]').find(r => r.checked)?.value || 'todos';
  let ids = [];
  if (mode === 'selecionar') {
    ids = qsa('#lead-checklist input[type="checkbox"]:checked').map(i => i.value);
    if (ids.length === 0) { toast('‚ùå Selecione pelo menos um lead'); return; }
  } else {
    ids = state.leads.map(l => l.id);
  }
  const isScheduled = qs('#schedule-check').checked;
  let scheduleDate = null;
  if (isScheduled) {
    const date = qs('#schedule-date').value;
    const time = qs('#schedule-time').value;
    if (!date || !time) { toast('‚ùå Defina data e hora para agendamento'); return; }
    scheduleDate = new Date(`${date}T${time}`);
    if (isNaN(scheduleDate.getTime()) || scheduleDate <= new Date()) { toast('‚ùå Data de agendamento inv√°lida'); return; }
  }

  const payload = {
    message: txt,
    mode,
    leadIds: ids,
    scheduled: isScheduled ? scheduleDate.toISOString() : null
  };
  const res = await apiRequest(`/whatsapp/send-bulk`, 'POST', payload);
  if (res?.success) {
    const count = mode === 'todos' ? state.leads.length : ids.length;
    const item = res.data || {
      id: crypto.randomUUID(),
      when: isScheduled ? scheduleDate.toISOString() : new Date().toISOString(),
      ok: isScheduled ? null : true,
      message: txt,
      count,
      scheduled: isScheduled
    };
    state.history.unshift(item);
    renderHistory();

    qs('#msg').value = '';
    qsa('#lead-checklist input[type="checkbox"]').forEach(cb => cb.checked = false);
    qs('#schedule-check').checked = false;
    qs('#schedule-options').style.display = 'none';
    toast(isScheduled ? `‚è∞ Disparo agendado para ${scheduleDate.toLocaleString('pt-BR')}` :
        `‚úÖ Mensagem enviada para ${count} lead(s)!`);
  } else {
    toast('‚ùå Falha ao enviar disparo');
  }
}

async function loadHistory(page = 1, limit = 50) {
  const res = await apiRequest(`/whatsapp/history?page=${page}&limit=${limit}`);
  if (res?.success) {
    state.history = res.data || res.items || [];
    renderHistory();
  }
}

function renderHistory() {
  const box = qs('#send-history');
  const historyCount = qs('#history-count');
  if (historyCount) historyCount.textContent = `${state.history.length} disparos`;
  
  box.innerHTML = state.history.map((h, index) => {
    const isPending = h.scheduled && new Date(h.when) > new Date();
    const statusDot = isPending ? '<span class="dot" style="background:linear-gradient(135deg, #ed8936, #dd6b20);"></span>' :
        `<span class="dot" style="background:${h.ok ? 'linear-gradient(135deg, #48bb78, #38a169)' : 'linear-gradient(135deg, #f56565, #e53e3e)'};"></span>`;
    const statusText = isPending ? '‚è∞ Agendado' : (h.ok ? '‚úÖ Enviado' : '‚ùå Falha');
    const statusIcon = isPending ? '‚è∞' : (h.ok ? '‚úÖ' : '‚ùå');
    return `
        <div class="card" style="animation: fadeUp 0.3s ease both; animation-delay: ${index * 0.05}s;">
          <div class="card-body">
            <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:8px;">
              <div style="display:flex; gap:10px; align-items:center;">
                ${statusDot}
                <strong>${statusText}</strong>
                <span class="badge">${new Date(h.when).toLocaleString('pt-BR')}</span>
              </div>
              <span class="badge">${statusIcon} ${h.count} destinat√°rio(s)</span>
            </div>
            <div style="white-space:pre-wrap; font-size:13px; color:var(--text-soft); line-height:1.4; padding:8px 0;">${escapeHTML(h.message)}</div>
          </div>
        </div>
      `;
  }).join('');
}
function escapeHTML(s) { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// ====== WHATSAPP ======
function renderWhatsApp() {
  const ind = qs('#wa-ind');
  const lab = qs('#wa-label');
  const qrElement = qs('#qr');
  const connectedElement = qs('#wa-connected');
  const refreshBtn = qs('#wa-refresh');
  
  ind.classList.toggle('on', state.whatsapp.status === 'online');
  lab.textContent = state.whatsapp.status === 'online' ? '‚úÖ Online' : '‚ö´ Offline';
  
  if (state.whatsapp.status === 'online') {
    qrElement.style.display = 'none';
    connectedElement.style.display = 'flex';
    refreshBtn.style.display = 'none';
  } else {
    qrElement.style.display = 'block';
    connectedElement.style.display = 'none';
    refreshBtn.style.display = 'inline-flex';
    
    qrElement.style.backgroundPosition = `${(state.whatsapp.qrSeed%32)}px ${(state.whatsapp.qrSeed%32)}px, ${(state.whatsapp.qrSeed%32)}px ${(state.whatsapp.qrSeed%32)}px, 0 0`;
    if (state.whatsapp.qr) {
      qrElement.style.backgroundImage = `url('${state.whatsapp.qr}')`;
      qrElement.style.backgroundSize = 'cover';
    }
  }
}

async function checkWhatsAppStatus() {
  const res = await apiRequest(`/whatsapp/status`);
  if (res?.success) {
    state.whatsapp.status = res.data?.status || res.status || state.whatsapp.status;
    renderWhatsApp();
  }
}

let waInterval = null;
function startWaPolling() {
  stopWaPolling();
  waInterval = setInterval(async () => {
    if (document.hidden) return;
    await checkWhatsAppStatus();
  }, 30 * 60 * 1000);
}
function stopWaPolling() {
  if (waInterval) { clearInterval(waInterval); waInterval = null; }
}

async function refreshQR() {
  const btn = qs('#wa-refresh');
  btn.disabled = true;
  btn.innerHTML = 'üîÑ Atualizando...';
  
  const res = await apiRequest(`/whatsapp/refresh-qr`, 'POST');
  if (res?.success) {
    state.whatsapp.qrSeed++;
    if (res.data?.qr) state.whatsapp.qr = res.data.qr;
    renderWhatsApp();
    toast('‚úÖ QR Code atualizado');
  } else {
    toast('‚ùå Falha ao atualizar QR Code');
  }
  
  btn.disabled = false;
  btn.innerHTML = 'üîÑ Atualizar QR Code';
}

// ====== MEM√ìRIA ======
async function renderMemList() {
  const term = (qs("#mem-filter").value || "").toLowerCase();
  
  const res = await apiRequest(`/memoria?search=${encodeURIComponent(term)}`);
  if (res?.success) {
    state.memoria = res.data || res.items || [];
  } else {
    toast("‚ùå Falha ao carregar mem√≥rias");
    state.memoria = [];
  }
  
  const filteredMem = state.memoria.filter(m => {
    if (!term) return true;
    const searchText = `${m.pergunta} ${m.resposta}`.toLowerCase();
    return searchText.includes(term);
  });
  
  // Update memory count
  const memoryCount = qs('#memory-count');
  if (memoryCount) memoryCount.textContent = `${filteredMem.length} mem√≥rias`;
  
  const el = qs("#mem-list");
  el.innerHTML = filteredMem.map((m, index) => `
    <div class="card" style="animation: slideInRight 0.3s ease both; animation-delay: ${index * 0.05}s;">
      <div class="card-body">
        <div style="font-size:14px;font-weight:700;margin-bottom:8px;color:var(--text);">‚ùì ${escapeHTML(m.pergunta)}</div>
        <div style="font-size:13px;color:var(--text-soft);margin-bottom:16px;white-space:pre-wrap;line-height:1.5;padding:8px 12px;background:var(--bg-soft);border-radius:8px;border:1px solid var(--card-border);">üí° ${escapeHTML(m.resposta)}</div>
        <div style="display:flex;gap:10px;">
          <button class="btn secondary" data-edit="${m.id}">‚úèÔ∏è Editar</button>
          <button class="btn" data-del="${m.id}">üóëÔ∏è Apagar</button>
        </div>
      </div>
    </div>
  `).join("");
  
  qsa("[data-edit]").forEach(b => b.onclick = () => openMemEdit(b.getAttribute("data-edit")));
  qsa("[data-del]").forEach(b => b.onclick = () => delMem(b.getAttribute("data-del")));
}

async function addMem() {
  const pergunta = (qs("#q").value || "").trim();
  const resposta = (qs("#a").value || "").trim();
  if (!pergunta || !resposta) { toast("‚ùå Preencha pergunta e resposta"); return; }
  
  const btn = qs('#mem-add');
  btn.disabled = true;
  btn.innerHTML = '‚è≥ Salvando...';
  
  const res = await apiRequest(`/memoria`, "POST", { pergunta, resposta });
  if (res?.success) {
    qs("#q").value = ""; qs("#a").value = "";
    await renderMemList();
    toast("‚úÖ Mem√≥ria adicionada com sucesso");
  } else {
    toast("‚ùå Erro ao adicionar mem√≥ria");
  }
  
  btn.disabled = false;
  btn.innerHTML = '‚ûï Adicionar Mem√≥ria';
}

function openMemEdit(id) {
  const item = state.memoria.find(m => m.id === id);
  if (!item) return;
  state.memEdit = { ...item };
  qs('#mem-edit-q').value = item.pergunta;
  qs('#mem-edit-a').value = item.resposta;
  qs('#mem-modal').classList.add('open');
}
function closeMemEdit() {
  qs('#mem-modal').classList.remove('open');
  state.memEdit = null;
}
async function saveMemEdit() {
  if (!state.memEdit?.id) return;
  const pergunta = (qs("#mem-edit-q").value || "").trim();
  const resposta = (qs("#mem-edit-a").value || "").trim();
  const body = {
    id: state.memEdit.id,
    pergunta,
    resposta
  };
  const res = await apiRequest(`/memoria/update`, "PUT", body);
  if (res?.success) {
    await renderMemList();
    closeMemEdit();
    toast("‚úÖ Mem√≥ria atualizada");
  } else {
    toast("‚ùå Erro ao atualizar mem√≥ria");
  }
}
async function delMem(id) {
  if (!confirm("üóëÔ∏è Confirmar exclus√£o desta mem√≥ria?")) return;
  const res = await apiRequest(`/memoria/delete`, "DELETE", { id });
  if (res?.success) {
    await renderMemList();
    toast("‚úÖ Mem√≥ria removida");
  } else {
    toast("‚ùå Erro ao remover mem√≥ria");
  }
}

// ====== M√âTRICAS / RANGE ======
async function setRange(days) {
  state.rangeDays = days;
  qsa(".segmented button").forEach(b => {
    const isActive = b.getAttribute("data-range") === String(days);
    b.classList.toggle("active", isActive);
    b.setAttribute("aria-selected", isActive);
  });
  const res = await apiRequest(`/dashboard/metrics?rangeDays=${days}`);
  if (res?.success) {
    const d = res.data || res;
    if (d.metrics) state.metrics = d.metrics;
    if (d.hourly) state.hourly = d.hourly;
    renderMetrics();
    renderHourlyChart();
    toast(`üìä M√©tricas atualizadas para ${days === 1 ? 'hoje' : days + ' dias'}`);
  } else {
    toast("‚ùå Falha ao atualizar m√©tricas");
  }
}

// ====== LOAD INITIAL ======
async function loadInitialData() {
  const res = await apiRequest(`/api/sync`);
  if (res?.success) {
    const d = res.data || res;
    state.metrics = d.metrics ?? state.metrics;
    state.hourly = d.hourly ?? state.hourly;
    state.leads = d.leads ?? state.leads;
    state.activeLead = null;
    state.whatsapp = d.whatsapp ?? state.whatsapp;
    renderMetrics();
    renderHourlyChart();
    renderDonut(computePie());
    renderLeads();
    renderWhatsApp();
    renderMemList();
    await loadHistory();
    toast("‚úÖ Dados carregados com sucesso");
  } else {
    toast("‚ö†Ô∏è Falha ao carregar dados iniciais");
  }
}

// ====== INIT / EVENTS ======
function init() {
  applyTheme();
  
  // Restore sidebar state
  if (window.innerWidth > 900) {
    const collapsed = localStorage.getItem('sidebar-collapsed') === '1';
    setSidebarCollapsed(collapsed);
  }
  
  // Theme / Sidebar controls
  qs("#toggleTheme").onclick = () => { 
    toggleTheme(); 
    toast(html.classList.contains('light') ? '‚òÄÔ∏è Tema claro ativado' : 'üåô Tema escuro ativado');
  };
  qs("#toggleSidebar").onclick = () => { toggleSidebar(); };

  // Enhanced Navigation
  qsa("a[data-link]").forEach(a => {
    a.onclick = async (e) => {
      e.preventDefault();
      const target = a.getAttribute("href") || "#dashboard";
      const sectionName = target.replace('#', '');
      
      qsa("a[data-link]").forEach(x => {
        const isActive = x === a;
        x.classList.toggle("active", isActive);
        x.setAttribute("aria-selected", isActive);
      });
      
      qsa("main > section").forEach(sec => {
        const isActive = "#" + sec.id === target;
        sec.classList.toggle("active", isActive);
      });
      
      history.replaceState(null, "", target);
      
      // Section-specific loading
      if (target === "#disparo") {
        await loadHistory();
        renderDisparoChecklist();
      } else if (target === "#leads") {
        await renderLeads();
      } else if (target === "#memoria") {
        await renderMemList();
      } else if (target === "#whatsapp") {
        await checkWhatsAppStatus();
      }
      
      // Close mobile sidebar
      if (window.innerWidth <= 900) {
        sidebar.classList.remove('open');
      }
      
      toast(`üìç Navegando para ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}`);
    };
  });

  // Enhanced Range controls
  qsa(".segmented button").forEach(b => {
    b.onclick = async () => { await setRange(Number(b.getAttribute("data-range") || "1")); }
  });

  // Enhanced Lead controls
  qs('#lead-search').addEventListener('input', debounce(() => renderLeads(), 300));
  qs('#lead-edit').onclick = openLeadModal;
  qs('#lead-save').onclick = saveLeadModal;
  qs('#lead-cancel').onclick = closeLeadModal;

  // Enhanced Disparo controls
  qsa('input[name="destino"]').forEach(r => r.onchange = () => {
    const sel = qs('#select-leads');
    const mode = qsa('input[name="destino"]').find(x => x.checked)?.value;
    sel.style.display = mode === 'selecionar' ? 'block' : 'none';
    if (mode === 'selecionar') renderDisparoChecklist();
  });
  qs('#lead-filter').addEventListener('input', debounce(renderDisparoChecklist, 300));
  qs('#schedule-check').onchange = () => {
    const options = qs('#schedule-options');
    options.style.display = qs('#schedule-check').checked ? 'grid' : 'none';
    if (qs('#schedule-check').checked) {
      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      qs('#schedule-date').value = tomorrow.toISOString().split('T')[0];
      qs('#schedule-time').value = '09:00';
    }
  };
  qs('#send').onclick = enviarDisparo;

  // Enhanced WhatsApp controls
  qs('#wa-refresh').onclick = refreshQR;
  startWaPolling();
  
  // Enhanced Memory controls
  qs('#mem-add').onclick = addMem;
  qs('#mem-filter').addEventListener('input', debounce(() => renderMemList(), 300));
  qs('#mem-save').onclick = saveMemEdit;
  qs('#mem-cancel').onclick = closeMemEdit;

  // Enhanced Modal controls
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeLeadModal();
      closeMemEdit();
      if (window.innerWidth <= 900) {
        sidebar.classList.remove('open');
      }
    }
  });

  // Enhanced Responsive handling
  window.addEventListener('resize', () => {
    if (window.innerWidth > 900) {
      sidebar.classList.remove('open');
    }
  });

  // Initial load with enhanced error handling
  loadInitialData().catch(() => {
    toast("‚ö†Ô∏è Alguns dados podem n√£o ter carregado completamente");
  });
}

// Utility function for debouncing
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

window.addEventListener('load', init);
</script>
</body>
</html>